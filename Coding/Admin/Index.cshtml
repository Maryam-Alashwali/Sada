@* Views/Admin/User/Index.cshtml *@
@model Sada.ViewModels.Admin.UserManagementViewModel
@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["Title"] = "User Management";
}

@section Styles {
    <style>
        .status-blocked {
            background: #d33535 !important;
        }

        .status-pending {
            background: #e6bf2d !important;
        }
    </style>
}

<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">User Management</h2>
            <p class="text-muted mb-0">Manage and moderate user accounts</p>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="data-card mb-4">
        <div class="row">
            <div class="col-md-8">
                <form asp-action="Index" method="get" id="filterForm">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Role</label>
                            <select name="role" class="form-select" onchange="document.getElementById('filterForm').submit()">
                                <option value="">All Roles</option>
                                <option value="client" selected="@(Model.RoleFilter == "client")">Clients</option>
                                <option value="tailor" selected="@(Model.RoleFilter == "tailor")">Tailors</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Status</label>
                            <select name="status" class="form-select" onchange="document.getElementById('filterForm').submit()">
                                <option value="">All Status</option>
                                <option value="active" selected="@(Model.StatusFilter == "active")">Active</option>
                                <option value="blocked" selected="@(Model.StatusFilter == "blocked")">Blocked</option>
                                <option value="pending" selected="@(Model.StatusFilter == "pending")">Pending</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">&nbsp;</label>
                            <a asp-action="Index" class="btn btn-outline-secondary w-100">Clear Filters</a>
                        </div>
                    </div>
                </form>
            </div>
            <div class="col-md-4">
                <form asp-action="Index" method="get">
                    <label class="form-label">Search</label>
                    <div class="input-group">
                        <input type="text" name="search" class="form-control" placeholder="Search by name or email..." value="@Model.SearchTerm">
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bulk Actions -->
    <div class="data-card mb-3" id="bulkActions" style="display: none;">
        <div class="d-flex justify-content-between align-items-center">
            <span id="selectedCount">0 users selected</span>
            <div class="d-flex gap-2">
                <select class="form-select form-select-sm" id="bulkActionSelect" style="width: auto;">
                    <option value="">Bulk Actions</option>
                    <option value="block">Block Selected</option>
                    <option value="unblock">Unblock Selected</option>
                </select>
                <button class="btn btn-sm btn-primary" id="applyBulkAction">Apply</button>
                <button class="btn btn-sm btn-outline-secondary" id="clearSelection">Clear</button>
            </div>
        </div>
    </div>

    <!-- Users Table -->
    <div class="data-card">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th width="50">
                            <input type="checkbox" id="selectAll">
                        </th>
                        <th>User</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Registration Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Users.Any())
                    {
                        @foreach (var user in Model.Users)
                        {
                            <tr>
                                <td>
                                    <input type="checkbox" class="user-checkbox" value="@user.UserId">
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="user-avatar me-3">
                                            <div class="rounded-circle bg-light-teal d-flex align-items-center justify-content-center"
                                                 style="width: 40px; height: 40px;">
                                                <i class="fas fa-user text-dark-blue"></i>
                                            </div>
                                        </div>
                                        <div>
                                            <h6 class="mb-1">@user.FullName</h6>
                                            <small class="text-muted">@user.Email</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge @(user.Role == "tailor" ? "bg-primary" : user.Role == "client" ? "bg-success" : "")">
                                        @user.Role.ToUpper()
                                    </span>
                                    @if (user.Role == "tailor" && user.IsApproved.HasValue)
                                    {
                                        <br>
                                        <small class="text-muted">
                                            @(user.IsApproved.Value ? "Verified" : "Pending Approval")
                                        </small>
                                    }
                                </td>
                                <td>
                                    <span class="badge status-@user.Status">@user.Status.ToUpper()</span>
                                </td>
                                <td>
                                    <small class="text-muted">
                                        @user.CreatedAt?.ToString("MMM d, yyyy")
                                    </small>
                                </td>
                                <td>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                            Actions
                                        </button>
                                        <ul class="dropdown-menu">
                                            @if (user.Status == "blocked")
                                            {
                                                <li>
                                                    <a class="dropdown-item text-success unblock-user" href="#"
                                                       data-user-id="@user.UserId">
                                                        <i class="fas fa-check-circle me-2"></i>Unblock Account
                                                    </a>
                                                </li>
                                            }
                                            else
                                            {
                                                <li>
                                                    <a class="dropdown-item text-warning block-user" href="#"
                                                       data-user-id="@user.UserId"
                                                       data-user-name="@user.Email">
                                                        <i class="fas fa-ban me-2"></i>Block Account
                                                    </a>
                                                </li>
                                            }

                                            @if (user.Role == "tailor" && user.IsApproved.HasValue && !user.IsApproved.Value)
                                            {
                                                <li>
                                                    <a class="dropdown-item text-success approve-tailor" href="#"
                                                       data-tailor-id="@user.UserId"
                                                       data-tailor-name="@user.FullName">
                                                        <i class="fas fa-user-check me-2"></i>Approve Tailor
                                                    </a>
                                                </li>
                                            }

                                            @if (user.Role == "tailor" && user.IsApproved.HasValue && user.IsApproved.Value)
                                            {
                                                <li>
                                                    <a class="dropdown-item text-warning reject-tailor" href="#"
                                                       data-tailor-id="@user.UserId"
                                                       data-tailor-name="@user.FullName">
                                                        <i class="fas fa-user-times me-2"></i>Reject Tailor
                                                    </a>
                                                </li>
                                            }
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                <h5>No users found</h5>
                                <p class="text-muted">Try adjusting your search or filters</p>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        @if (Model.TotalPages > 1)
        {
            <div class="d-flex justify-content-between align-items-center mt-4">
                <div class="text-muted">
                    Showing @((Model.CurrentPage - 1) * Model.PageSize + 1) to @(Math.Min(Model.CurrentPage * Model.PageSize, Model.TotalCount)) of @Model.TotalCount users
                </div>
                <nav>
                    <ul class="pagination">
                        @for (int i = 1; i <= Model.TotalPages; i++)
                        {
                            <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                <a class="page-link" asp-action="Index"
                                   asp-route-page="@i"
                                   asp-route-search="@Model.SearchTerm"
                                   asp-route-role="@Model.RoleFilter"
                                   asp-route-status="@Model.StatusFilter">@i</a>
                            </li>
                        }
                    </ul>
                </nav>
            </div>
        }
    </div>
</div>

<!-- Block User Modal -->
<div class="modal fade" id="blockUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Block User Account</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>You are about to block <strong id="blockUserName"></strong>.</p>
                <div class="mb-3">
                    <label for="blockReason" class="form-label">Reason for blocking (optional)</label>
                    <textarea class="form-control" id="blockReason" rows="3"
                              placeholder="Enter reason for blocking this account..."></textarea>
                </div>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Blocked users will not be able to access their accounts until unblocked.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirmBlock">
                    <i class="fas fa-ban me-2"></i>Block Account
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let selectedUserId = null;

            // Block user modal
            document.querySelectorAll('.block-user').forEach(button => {
                button.addEventListener('click', function() {
                    selectedUserId = this.dataset.userId;
                    document.getElementById('blockUserName').textContent = this.dataset.userName;
                    new bootstrap.Modal(document.getElementById('blockUserModal')).show();
                });
            });

            // Confirm block
            document.getElementById('confirmBlock').addEventListener('click', function() {
                const reason = document.getElementById('blockReason').value;
                const button = this;

                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Blocking...';

                fetch(`/Admin/User/BlockUser`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify({
                        UserId: selectedUserId,
                        Reason: reason
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert(data.message);
                    }
                })
                .finally(() => {
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-ban me-2"></i>Block Account';
                });
            });

            // Unblock user
            document.querySelectorAll('.unblock-user').forEach(button => {
                button.addEventListener('click', function() {
                    if (confirm('Are you sure you want to unblock this user?')) {
                        const userId = this.dataset.userId;

                        fetch(`/Admin/User/UnblockUser`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                            },
                            body: JSON.stringify({ userId: userId })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                location.reload();
                            } else {
                                alert(data.message);
                            }
                        });
                    }
                });
            });

            // Bulk actions
            const selectAll = document.getElementById('selectAll');
            const userCheckboxes = document.querySelectorAll('.user-checkbox');
            const bulkActions = document.getElementById('bulkActions');
            const selectedCount = document.getElementById('selectedCount');
            const clearSelection = document.getElementById('clearSelection');
            const applyBulkAction = document.getElementById('applyBulkAction');
            const bulkActionSelect = document.getElementById('bulkActionSelect');

            function updateBulkActions() {
                const selected = document.querySelectorAll('.user-checkbox:checked');
                const count = selected.length;

                if (count > 0) {
                    bulkActions.style.display = 'block';
                    selectedCount.textContent = `${count} user${count > 1 ? 's' : ''} selected`;
                } else {
                    bulkActions.style.display = 'none';
                }
            }

            selectAll.addEventListener('change', function() {
                userCheckboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                updateBulkActions();
            });

            userCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateBulkActions);
            });

            clearSelection.addEventListener('click', function() {
                userCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                selectAll.checked = false;
                updateBulkActions();
            });

            applyBulkAction.addEventListener('click', function() {
                const action = bulkActionSelect.value;
                if (!action) {
                    alert('Please select an action');
                    return;
                }

                const selectedIds = Array.from(document.querySelectorAll('.user-checkbox:checked'))
                    .map(checkbox => parseInt(checkbox.value));

                if (selectedIds.length === 0) {
                    alert('Please select at least one user');
                    return;
                }

                if (confirm(`Are you sure you want to ${action} ${selectedIds.length} user(s)?`)) {
                    fetch('/Admin/User/BulkAction', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                        },
                        body: JSON.stringify({
                            UserIds: selectedIds,
                            Action: action
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert(data.message);
                        }
                    });
                }
            });

            // Approve tailor
            document.querySelectorAll('.approve-tailor').forEach(button => {
                button.addEventListener('click', function() {
                    if (confirm(`Are you sure you want to approve ${this.dataset.tailorName} as a tailor?`)) {
                        const tailorId = this.dataset.tailorId;

                        fetch(`/Admin/User/ApproveTailor`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                            },
                            body: JSON.stringify({ tailorId: parseInt(tailorId) })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                location.reload();
                            } else {
                                alert(data.message);
                            }
                        });
                    }
                });
            });

            // Reject tailor
            document.querySelectorAll('.reject-tailor').forEach(button => {
                button.addEventListener('click', function() {
                    const reason = prompt(`Rejection reason for ${this.dataset.tailorName}:`);
                    if (reason !== null) {
                        const tailorId = this.dataset.tailorId;

                        fetch(`/Admin/User/RejectTailor`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                            },
                            body: JSON.stringify({
                                tailorId: parseInt(tailorId),
                                reason: reason
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                location.reload();
                            } else {
                                alert(data.message);
                            }
                        });
                    }
                });
            });
        });
    </script>
}

@* Hidden anti-forgery token *@
<form id="__AjaxAntiForgeryForm" style="display:none;">
    @Html.AntiForgeryToken()
</form>